<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŸ¥è¡ŒAI ä¸‰ç»´æ¯”ä»·ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <style>
        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .main-container {
            display: flex;
            max-width: 1600px;
            margin: 0 auto;
            gap: 20px;
        }
        .content-container {
            flex: 1;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        .data-list-container {
            width: 300px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        .data-list-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #2196F3;
        }
        .data-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: calc(100vh - 150px);
            overflow-y: auto;
        }
        .data-list li {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
        }
        .data-list li:hover {
            background-color: #f0f7ff;
        }
        .data-list li:active {
            background-color: #e3f2fd;
        }
        .data-list li .file-icon {
            margin-right: 10px;
            color: #2196F3;
        }
        .data-list li .file-name {
            flex: 1;
        }
        .data-list li .file-date {
            font-size: 12px;
            color: #666;
        }
        .data-list-description {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            padding: 5px;
            background-color: #f8f8f8;
            border-radius: 4px;
            text-align: center;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 6px;
        }
        .control-group {
            flex: 1;
            min-width: 250px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        select, input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            box-sizing: border-box;
        }
        .search-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .search-btn {
            background-color: #2196F3;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
        }
        .search-btn:hover {
            background-color: #0b7dda;
        }
        .checkbox-control {
            display: flex;
            align-items: center;
            margin-top: 15px;
        }
        .checkbox-control input {
            margin-right: 8px;
        }
        .file-upload {
            display: flex;
            flex-direction: column;
            padding: 15px;
            background-color: #f0f7ff;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .upload-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        .upload-btn:hover {
            background-color: #45a049;
        }
        .chart-container {
            position: relative;
            height: 70vh;
            margin-top: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
            background-color: #fcfcfc;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            overflow-x: auto;
            display: block;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .data-table th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
            cursor: pointer;
            user-select: none;
        }
        .data-table th:hover {
            background-color: #e5e5e5;
        }
        .data-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .data-table tr:hover {
            background-color: #f1f1f1;
        }
        .highlighted-row {
            background-color: #fffacd !important;
        }
        .sort-icon {
            display: inline-block;
            width: 0;
            height: 0;
            margin-left: 5px;
            vertical-align: middle;
        }
        .sort-icon.asc {
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 5px solid #333;
        }
        .sort-icon.desc {
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid #333;
        }
        .system-title {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .system-title h1 {
            margin: 0;
            margin-bottom: 0;
            background: linear-gradient(45deg, #1976d2, #4CAF50);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: bold;
        }
        .search-result {
            margin-top: 5px;
            font-size: 14px;
            color: #666;
        }
        .loading-indicator {
            display: none;
            text-align: center;
            margin: 10px 0;
            font-style: italic;
            color: #666;
        }
        .loading-indicator.active {
            display: block;
        }
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            .chart-container {
                height: 50vh;
            }
            .search-group {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="content-container">
            <div class="container">
                <div class="system-title">
                    <h1>çŸ¥è¡ŒAI ä¸‰ç»´æ¯”ä»·ç³»ç»Ÿ</h1>
                </div>
                
                <div class="file-upload">
                    <label for="fileInput">ä¸Šä¼ æ–‡ä»¶ (æ”¯æŒExcelå’ŒCSVæ ¼å¼):</label>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" />
                    <button class="upload-btn" onclick="processFile()">å¤„ç†æ•°æ®</button>
                </div>
                
                <div class="controls">
                    <div class="control-group">
                        <label for="xAxis">é€‰æ‹©Xè½´æ•°æ®:</label>
                        <select id="xAxis" onchange="updateChart()">
                            <!-- é€‰é¡¹å°†åŠ¨æ€ç”Ÿæˆ -->
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="yAxis">é€‰æ‹©Yè½´æ•°æ®:</label>
                        <select id="yAxis" onchange="updateChart()">
                            <!-- é€‰é¡¹å°†åŠ¨æ€ç”Ÿæˆ -->
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="bubbleSize">æ°”æ³¡å¤§å°è¡¨ç¤º:</label>
                        <select id="bubbleSize" onchange="updateChart()">
                            <!-- é€‰é¡¹å°†åŠ¨æ€ç”Ÿæˆ -->
                        </select>
                        <div class="checkbox-control">
                            <input type="checkbox" id="showLabels" checked onchange="updateChart()">
                            <label for="showLabels">æ˜¾ç¤ºæ‰€æœ‰è‚¡ç¥¨åç§°</label>
                        </div>
                    </div>
                </div>
                
                <div class="search-group">
                    <label for="searchStock" style="min-width: 80px;">æœç´¢è‚¡ç¥¨:</label>
                    <input type="text" id="searchStock" placeholder="è¾“å…¥è‚¡ç¥¨åç§°æˆ–ä»£ç ">
                    <button class="search-btn" onclick="searchStock()">æœç´¢</button>
                    <div class="search-result" id="searchResult"></div>
                </div>
                
                <div class="chart-container">
                    <canvas id="stockChart"></canvas>
                </div>
                
                <div style="overflow-x: auto; margin-top: 30px;">
                    <table class="data-table" id="dataTable">
                        <thead id="tableHeader">
                            <!-- è¡¨å¤´å°†åŠ¨æ€ç”Ÿæˆ -->
                        </thead>
                        <tbody id="tableBody">
                            <!-- æ•°æ®å°†åŠ¨æ€ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="data-list-container">
            <div class="data-list-title">çŸ¥è¡ŒAIç”¨æˆ·ä¸“å±æ•°æ®åˆ—è¡¨</div>
            <div class="data-list-description">åŒå‡»åŠ è½½æ•°æ®è¡¨</div>
            <div id="dataListLoading" class="loading-indicator">æ­£åœ¨åŠ è½½æ•°æ®åˆ—è¡¨...</div>
            <ul class="data-list" id="userDataList">
                <!-- æ•°æ®åˆ—è¡¨é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
            </ul>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let stockData = [];
        let myChart = null;
        let columns = [];
        let highlightedStock = null;
        let sortConfig = {
            column: null,
            direction: 'asc'
        };
        
        // GitHubä»“åº“é…ç½®
        const repoOwner = 'YOUR_GITHUB_USERNAME'; // æ›¿æ¢ä¸ºæ‚¨çš„GitHubç”¨æˆ·å
        const repoName = 'YOUR_REPO_NAME';        // æ›¿æ¢ä¸ºæ‚¨çš„ä»“åº“å
        const dataFolder = 'data';                // æ•°æ®æ–‡ä»¶å­˜æ”¾çš„æ–‡ä»¶å¤¹è·¯å¾„

        // é…ç½®æ•°æ®æ–‡ä»¶çš„ä¿¡æ¯ (å¯ä»¥åœ¨GitHubä¸Šæ·»åŠ è¿™äº›æ–‡ä»¶)
        const dataFiles = [
            // è¿™é‡Œä¼šè‡ªåŠ¨ä»ä»“åº“ä¸­è¯»å–
        ];
        
        // é»˜è®¤æ•°æ®
        const defaultData = [
            {ä»£ç : "002536", åç§°: "é£é¾™è‚¡ä»½", æ¦‚ç‡: 86.05, èµ”ç‡: 102.27, å‡¯åˆ©ä»“ä½: 77.35, åŠå‡¯åˆ©ä»“ä½: 38.67, æ­¢æŸä»·: 6.13, æ­¢æŸæ¯”ä¾‹: 58.36, ç›ˆäºæ¯”: 1.60},
            {ä»£ç : "603286", åç§°: "æ—¥ç›ˆç”µå­", æ¦‚ç‡: 67.50, èµ”ç‡: 57.47, å‡¯åˆ©ä»“ä½: 42.03, åŠå‡¯åˆ©ä»“ä½: 21.02, æ­¢æŸä»·: 16.07, æ­¢æŸæ¯”ä¾‹: 40.54, ç›ˆäºæ¯”: 1.28},
            {ä»£ç : "000678", åç§°: "è¥„é˜³è½´æ‰¿", æ¦‚ç‡: 73.77, èµ”ç‡: 74.56, å‡¯åˆ©ä»“ä½: 53.52, åŠå‡¯åˆ©ä»“ä½: 26.76, æ­¢æŸä»·: 5.41, æ­¢æŸæ¯”ä¾‹: 54.42, ç›ˆäºæ¯”: 1.30},
            {ä»£ç : "603009", åç§°: "åŒ—ç‰¹ç§‘æŠ€", æ¦‚ç‡: 62.50, èµ”ç‡: 90.99, å‡¯åˆ©ä»“ä½: 29.45, åŠå‡¯åˆ©ä»“ä½: 14.73, æ­¢æŸä»·: 9.60, æ­¢æŸæ¯”ä¾‹: 75.86, ç›ˆäºæ¯”: 1.13},
            {ä»£ç : "301459", åç§°: "ä¸°èŒ‚è‚¡ä»½", æ¦‚ç‡: 57.14, èµ”ç‡: 39.84, å‡¯åˆ©ä»“ä½: 14.17, åŠå‡¯åˆ©ä»“ä½: 7.08, æ­¢æŸä»·: 31.70, æ­¢æŸæ¯”ä¾‹: 34.59, ç›ˆäºæ¯”: 1.00},
            {ä»£ç : "301225", åç§°: "æ’å‹ƒè‚¡ä»½", æ¦‚ç‡: 55.56, èµ”ç‡: 32.27, å‡¯åˆ©ä»“ä½: -12.00, åŠå‡¯åˆ©ä»“ä½: -6.00, æ­¢æŸä»·: 20.50, æ­¢æŸæ¯”ä¾‹: 46.87, ç›ˆäºæ¯”: 0.66},
            {ä»£ç : "603758", åç§°: "ç§¦å®‰è‚¡ä»½", æ¦‚ç‡: 50.00, èµ”ç‡: 29.94, å‡¯åˆ©ä»“ä½: -25.58, åŠå‡¯åˆ©ä»“ä½: -12.79, æ­¢æŸä»·: 6.31, æ­¢æŸæ¯”ä¾‹: 41.62, ç›ˆäºæ¯”: 0.66},
            {ä»£ç : "600699", åç§°: "å‡èƒœç”µå­", æ¦‚ç‡: 60.00, èµ”ç‡: 45.00, å‡¯åˆ©ä»“ä½: -18.03, åŠå‡¯åˆ©ä»“ä½: -9.01, æ­¢æŸä»·: 15.21, æ­¢æŸæ¯”ä¾‹: 1.10, ç›ˆäºæ¯”: 0.51},
            {ä»£ç : "002662", åç§°: "äº¬å¨è‚¡ä»½", æ¦‚ç‡: 54.00, èµ”ç‡: 58.66, å‡¯åˆ©ä»“ä½: 87.47, åŠå‡¯åˆ©ä»“ä½: 43.73, æ­¢æŸä»·: 3.53, æ­¢æŸæ¯”ä¾‹: -2.10, ç›ˆäºæ¯”: -1.37},
            {ä»£ç : "002406", åç§°: "è¿œä¸œä¼ åŠ¨", æ¦‚ç‡: 61.36, èµ”ç‡: 46.82, å‡¯åˆ©ä»“ä½: 21.50, åŠå‡¯åˆ©ä»“ä½: 10.75, æ­¢æŸä»·: 5.01, æ­¢æŸæ¯”ä¾‹: 27.20, ç›ˆäºæ¯”: 0.97},
            {ä»£ç : "301607", åç§°: "å¯Œç‰¹ç§‘æŠ€", æ¦‚ç‡: 0.00, èµ”ç‡: 8.23, å‡¯åˆ©ä»“ä½: -344.37, åŠå‡¯åˆ©ä»“ä½: -172.18, æ­¢æŸä»·: 30.05, æ­¢æŸæ¯”ä¾‹: 27.63, ç›ˆäºæ¯”: 0.29},
            {ä»£ç : "001380", åç§°: "åçº¬ç§‘æŠ€", æ¦‚ç‡: 85.71, èµ”ç‡: 68.32, å‡¯åˆ©ä»“ä½: 75.26, åŠå‡¯åˆ©ä»“ä½: 37.63, æ­¢æŸä»·: 14.77, æ­¢æŸæ¯”ä¾‹: 46.73, ç›ˆäºæ¯”: 1.37},
            {ä»£ç : "002328", åç§°: "æ–°æœ‹è‚¡ä»½", æ¦‚ç‡: 70.21, èµ”ç‡: 41.64, å‡¯åˆ©ä»“ä½: 55.57, åŠå‡¯åˆ©ä»“ä½: 27.79, æ­¢æŸä»·: 3.58, æ­¢æŸæ¯”ä¾‹: 31.60, ç›ˆäºæ¯”: 2.03},
            {ä»£ç : "001282", åç§°: "ä¸‰è”é”»é€ ", æ¦‚ç‡: 50.00, èµ”ç‡: 34.42, å‡¯åˆ©ä»“ä½: -5.99, åŠå‡¯åˆ©ä»“ä½: -2.99, æ­¢æŸä»·: 16.24, æ­¢æŸæ¯”ä¾‹: 29.95, ç›ˆäºæ¯”: 0.89},
            {ä»£ç : "002547", åç§°: "æ˜¥å…´ç²¾å·¥", æ¦‚ç‡: 91.43, èµ”ç‡: 143.38, å‡¯åˆ©ä»“ä½: 91.11, åŠå‡¯åˆ©ä»“ä½: 45.56, æ­¢æŸä»·: 4.27, æ­¢æŸæ¯”ä¾‹: -5.35, ç›ˆäºæ¯”: 27.09}
        ];

        // åˆå§‹åŒ–é¡µé¢
        window.onload = function() {
            stockData = defaultData;
            initializeData();
            
            // ä¸ºæœç´¢æ¡†æ·»åŠ å›è½¦é”®äº‹ä»¶ç›‘å¬
            document.getElementById('searchStock').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchStock();
                }
            });

            // åŠ è½½GitHubæ•°æ®æ–‡ä»¶åˆ—è¡¨
            loadGitHubDataFiles();
        };

        // åŠ è½½GitHubä»“åº“ä¸­çš„æ•°æ®æ–‡ä»¶åˆ—è¡¨
        async function loadGitHubDataFiles() {
            try {
                showDataListLoading(true);
                
                // è·å–ä»“åº“å†…å®¹
                const response = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${dataFolder}`);
                
                if (!response.ok) {
                    throw new Error(`GitHub APIè¿”å›é”™è¯¯: ${response.status}`);
                }
                
                const files = await response.json();
                
                // ç­›é€‰å‡ºCSVå’ŒExcelæ–‡ä»¶
                const dataFiles = files.filter(file => {
                    const ext = file.name.split('.').pop().toLowerCase();
                    return ext === 'csv' || ext === 'xlsx' || ext === 'xls';
                });
                
                // æŒ‰ä¿®æ”¹æ—¶é—´å¯¹æ–‡ä»¶è¿›è¡Œæ’åºï¼ˆéœ€è¦é¢å¤–è¯·æ±‚è·å–æäº¤ä¿¡æ¯ï¼‰
                const fileDetailsPromises = dataFiles.map(async file => {
                    try {
                        const commitsResponse = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/commits?path=${file.path}&page=1&per_page=1`);
                        const commits = await commitsResponse.json();
                        
                        // å¦‚æœæœ‰æäº¤å†å²ï¼Œä½¿ç”¨æœ€æ–°æäº¤çš„æ—¥æœŸ
                        let lastModified = new Date();
                        let commitMessage = '';
                        
                        if (commits && commits.length > 0) {
                            lastModified = new Date(commits[0].commit.committer.date);
                            commitMessage = commits[0].commit.message;
                        }
                        
                        return {
                            name: file.name,
                            path: file.path,
                            download_url: file.download_url,
                            lastModified: lastModified,
                            commitMessage: commitMessage
                        };
                    } catch (error) {
                        console.error(`è·å–æ–‡ä»¶ ${file.name} çš„æäº¤ä¿¡æ¯å¤±è´¥:`, error);
                        return {
                            name: file.name,
                            path: file.path,
                            download_url: file.download_url,
                            lastModified: new Date(0), // ä½¿ç”¨æœ€æ—©çš„æ—¥æœŸ
                            commitMessage: ''
                        };
                    }
                });
                
                const fileDetails = await Promise.all(fileDetailsPromises);
                
                // æŒ‰æœ€åä¿®æ”¹æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨æœ€å‰é¢ï¼‰
                fileDetails.sort((a, b) => b.lastModified - a.lastModified);
                
                updateDataFilesList(fileDetails);
            } catch (error) {
                console.error('åŠ è½½GitHubæ•°æ®æ–‡ä»¶å¤±è´¥:', error);
                document.getElementById('userDataList').innerHTML = `
                    <li style="color: #f44336;">
                        <span class="file-icon">âŒ</span>
                        <span class="file-name">åŠ è½½æ•°æ®æ–‡ä»¶åˆ—è¡¨å¤±è´¥</span>
                    </li>
                `;
            } finally {
                showDataListLoading(false);
            }
        }

        // æ›´æ–°æ•°æ®æ–‡ä»¶åˆ—è¡¨
        function updateDataFilesList(files) {
            const listElement = document.getElementById('userDataList');
            listElement.innerHTML = '';

            if (files.length === 0) {
                listElement.innerHTML = `
                    <li style="color: #666; font-style: italic;">
                        <span class="file-icon">ğŸ“‚</span>
                        <span class="file-name">æš‚æ— æ•°æ®æ–‡ä»¶</span>
                    </li>
                `;
                return;
            }

            files.forEach(file => {
                const li = document.createElement('li');
                
                // æ ¹æ®æ–‡ä»¶æ‰©å±•åæ˜¾ç¤ºä¸åŒçš„å›¾æ ‡
                const fileExt = file.name.split('.').pop().toLowerCase();
                let fileIcon = 'ğŸ“„';
                
                if (fileExt === 'csv') {
                    fileIcon = 'ğŸ“Š';
                } else if (fileExt === 'xlsx' || fileExt === 'xls') {
                    fileIcon = 'ğŸ“ˆ';
                }
                
                // æå–æ–‡ä»¶åï¼ˆå»æ‰æ‰©å±•åå’Œæ—¥æœŸå‰ç¼€ï¼‰
                let displayName = file.name;
                
                // æå–æ–‡ä»¶æ ‡é¢˜ï¼ˆä»æäº¤ä¿¡æ¯ä¸­ï¼‰
                let fileDescription = '';
                if (file.commitMessage) {
                    // ä»æäº¤ä¿¡æ¯ä¸­æå–æè¿°ï¼ˆå¦‚æœæœ‰ï¼‰
                    const descMatch = file.commitMessage.match(/^.*?:\s*(.*?)$/);
                    if (descMatch && descMatch[1]) {
                        fileDescription = descMatch[1];
                    } else {
                        fileDescription = file.commitMessage;
                    }
                }
                
                // æ ¼å¼åŒ–æ—¥æœŸ
                const formattedDate = file.lastModified.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                li.innerHTML = `
                    <span class="file-icon">${fileIcon}</span>
                    <span class="file-name" title="${fileDescription || displayName}">
                        ${displayName}
                        ${fileDescription ? `<small style="display:block;color:#666;font-size:90%;">${fileDescription}</small>` : ''}
                    </span>
                    <span class="file-date">${formattedDate}</span>
                `;
                
                // æ·»åŠ åŒå‡»äº‹ä»¶å¤„ç†ç¨‹åº
                li.addEventListener('dblclick', () => loadDataFromGitHub(file.download_url, fileExt));
                
                listElement.appendChild(li);
            });
        }

        // æ˜¾ç¤ºæˆ–éšè—æ•°æ®åˆ—è¡¨åŠ è½½æŒ‡ç¤ºå™¨
        function showDataListLoading(show) {
            const loadingElement = document.getElementById('dataListLoading');
            if (show) {
                loadingElement.classList.add('active');
            } else {
                loadingElement.classList.remove('active');
            }
        }

        // ä»GitHubä¸‹è½½å¹¶åŠ è½½æ•°æ®æ–‡ä»¶
        async function loadDataFromGitHub(fileUrl, fileType) {
            try {
                showDataListLoading(true);
                
                const response = await fetch(fileUrl);
                
                if (!response.ok) {
                    throw new Error(`ä¸‹è½½æ–‡ä»¶å¤±è´¥: ${response.status}`);
                }
                
                // æ ¹æ®æ–‡ä»¶ç±»å‹å¤„ç†æ•°æ®
                if (fileType === 'csv') {
                    const csvText = await response.text();
                    processRemoteCsvData(csvText);
                } else if (fileType === 'xlsx' || fileType === 'xls') {
                    const arrayBuffer = await response.arrayBuffer();
                    processRemoteExcelData(arrayBuffer);
                } else {
                    alert('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼');
                }
            } catch (error) {
                console.error('åŠ è½½æ•°æ®æ–‡ä»¶å¤±è´¥:', error);
                alert('åŠ è½½æ•°æ®æ–‡ä»¶å¤±è´¥: ' + error.message);
            } finally {
                showDataListLoading(false);
            }
        }

        // å¤„ç†è¿œç¨‹CSVæ•°æ®
        function processRemoteCsvData(csvText) {
            Papa.parse(csvText, {
                header: true,
                dynamicTyping: true,
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        // è¿‡æ»¤æ‰ç©ºè¡Œ
                        const filteredData = results.data.filter(row => 
                            Object.keys(row).length > 0 && 
                            Object.values(row).some(val => val !== null && val !== '')
                        );
                        
                        if (filteredData.length > 0) {
                            // æ£€æŸ¥æ•°æ®æ ¼å¼
                            if ('åç§°' in filteredData[0]) {
                                stockData = filteredData;
                                initializeData();
                            } else {
                                alert('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ã€‚è¯·ç¡®ä¿æ–‡ä»¶åŒ…å«å¿…è¦çš„åˆ—ï¼ˆå¦‚åç§°ç­‰ï¼‰ã€‚');
                            }
                        } else {
                            alert('æ–‡ä»¶æ•°æ®ä¸ºç©ºæˆ–æ— æ•ˆã€‚');
                        }
                    } else {
                        alert('æ–‡ä»¶æ•°æ®ä¸ºç©ºã€‚');
                    }
                },
                error: function(error) {
                    console.error('å¤„ç†CSVæ•°æ®æ—¶å‡ºé”™:', error);
                    alert('å¤„ç†CSVæ•°æ®æ—¶å‡ºé”™: ' + error.message);
                }
            });
        }

        // å¤„ç†è¿œç¨‹Excelæ•°æ®
        function processRemoteExcelData(arrayBuffer) {
            try {
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                
                // è½¬æ¢ä¸ºJSON
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                // æ£€æŸ¥æ•°æ®æ ¼å¼
                if (jsonData.length > 0 && 'åç§°' in jsonData[0]) {
                    stockData = jsonData;
                    initializeData();
                } else {
                    alert('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ã€‚è¯·ç¡®ä¿æ–‡ä»¶åŒ…å«å¿…è¦çš„åˆ—ï¼ˆå¦‚åç§°ç­‰ï¼‰ã€‚');
                }
            } catch (error) {
                console.error('å¤„ç†Excelæ•°æ®æ—¶å‡ºé”™:', error);
                alert('å¤„ç†Excelæ•°æ®æ—¶å‡ºé”™: ' + error.message);
            }
        }

        // åˆå§‹åŒ–æ•°æ®å’Œç•Œé¢
        function initializeData() {
            // æå–åˆ—ä¿¡æ¯
            if (stockData.length > 0) {
                columns = Object.keys(stockData[0]);
            }
            
            // ç¡®ä¿æ‰€æœ‰æ•°æ®ä¸ºæ•°å­—ï¼Œå¹¶ä¸”ä»£ç å§‹ç»ˆä¸ºå­—ç¬¦ä¸²
            stockData = stockData.map(item => {
                const newItem = {...item};
                // ç¡®ä¿ä»£ç æ˜¯å­—ç¬¦ä¸²ç±»å‹
                if (newItem.ä»£ç  !== undefined) {
                    newItem.ä»£ç  = String(newItem.ä»£ç );
                }
                
                for (const key in newItem) {
                    if (key !== 'ä»£ç ' && key !== 'åç§°' && typeof newItem[key] === 'string') {
                        // ç§»é™¤ç™¾åˆ†å·å¹¶è½¬æ¢ä¸ºæ•°å­—
                        if (newItem[key].endsWith('%')) {
                            newItem[key] = parseFloat(newItem[key].replace('%', ''));
                        } else {
                            const parsed = parseFloat(newItem[key]);
                            if (!isNaN(parsed)) {
                                newItem[key] = parsed;
                            }
                        }
                    }
                }
                return newItem;
            });
            
            // åˆå§‹åŒ–ä¸‹æ‹‰é€‰æ‹©æ¡†
            initializeSelects();
            
            // åˆå§‹åŒ–è¡¨æ ¼
            initializeTable();
            
            // æ›´æ–°å›¾è¡¨
            updateChart();
            
            // é‡ç½®é«˜äº®çŠ¶æ€
            highlightedStock = null;
        }

        // åˆå§‹åŒ–é€‰æ‹©ä¸‹æ‹‰æ¡†
        function initializeSelects() {
            const xAxisSelect = document.getElementById('xAxis');
            const yAxisSelect = document.getElementById('yAxis');
            const bubbleSizeSelect = document.getElementById('bubbleSize');
            
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            xAxisSelect.innerHTML = '';
            yAxisSelect.innerHTML = '';
            bubbleSizeSelect.innerHTML = '';
            
            // æ·»åŠ é€‰é¡¹ï¼ˆæ’é™¤ä»£ç å’Œåç§°ï¼‰
            const numericColumns = columns.filter(col => col !== 'ä»£ç ' && col !== 'åç§°');
            
            numericColumns.forEach((col, index) => {
                xAxisSelect.add(new Option(col, col, index === 0, index === 0));
                yAxisSelect.add(new Option(col, col, index === 1, index === 1));
                bubbleSizeSelect.add(new Option(col, col, index === 2, index === 2));
            });
        }

        // åˆå§‹åŒ–è¡¨æ ¼
        function initializeTable() {
            // åˆ›å»ºè¡¨å¤´
            const tableHeader = document.getElementById('tableHeader');
            tableHeader.innerHTML = '';
            
            const headerRow = document.createElement('tr');
            
            columns.forEach(column => {
                const th = document.createElement('th');
                th.textContent = column;
                th.onclick = () => sortTable(column);
                
                // æ·»åŠ æ’åºå›¾æ ‡å®¹å™¨
                const sortIcon = document.createElement('span');
                sortIcon.className = 'sort-icon';
                if (sortConfig.column === column) {
                    sortIcon.classList.add(sortConfig.direction);
                }
                th.appendChild(sortIcon);
                
                headerRow.appendChild(th);
            });
            
            tableHeader.appendChild(headerRow);
            
            // æ›´æ–°è¡¨æ ¼æ•°æ®
            updateTable();
        }

        // æœç´¢è‚¡ç¥¨å¹¶é«˜äº®æ˜¾ç¤º
        function searchStock() {
            const searchTerm = document.getElementById('searchStock').value.trim().toLowerCase();
            const searchResult = document.getElementById('searchResult');
            
            if (!searchTerm) {
                searchResult.textContent = '';
                // æ¸…é™¤é«˜äº®çŠ¶æ€
                highlightedStock = null;
                updateTable();
                updateChart();
                return;
            }
            
            // æŸ¥æ‰¾åŒ¹é…çš„è‚¡ç¥¨
            const matchedStocks = stockData.filter(stock => {
                // å®‰å…¨åœ°è½¬æ¢ä¸ºå­—ç¬¦ä¸²å¹¶æ¯”è¾ƒ
                const stockName = stock.åç§° ? String(stock.åç§°).toLowerCase() : '';
                const stockCode = stock.ä»£ç  ? String(stock.ä»£ç ).toLowerCase() : '';
                
                return stockName.includes(searchTerm) || stockCode.includes(searchTerm);
            });
            
            if (matchedStocks.length === 0) {
                searchResult.textContent = 'æœªæ‰¾åˆ°åŒ¹é…çš„è‚¡ç¥¨';
                // æ¸…é™¤é«˜äº®çŠ¶æ€
                highlightedStock = null;
            } else if (matchedStocks.length === 1) {
                // å•ä¸ªåŒ¹é…ï¼Œé«˜äº®æ˜¾ç¤º
                highlightedStock = matchedStocks[0];
                searchResult.textContent = `å·²æ‰¾åˆ°: ${highlightedStock.åç§°} (${highlightedStock.ä»£ç })`;
                
                // æ»šåŠ¨åˆ°è¡¨æ ¼ä¸­çš„å¯¹åº”è¡Œ
                scrollToTableRow(highlightedStock);
            } else {
                // å¤šä¸ªåŒ¹é…ï¼Œæ˜¾ç¤ºç¬¬ä¸€ä¸ªå¹¶æç¤º
                highlightedStock = matchedStocks[0];
                searchResult.textContent = `æ‰¾åˆ°${matchedStocks.length}ä¸ªåŒ¹é…ç»“æœï¼Œæ˜¾ç¤ºç¬¬ä¸€ä¸ª: ${highlightedStock.åç§°} (${highlightedStock.ä»£ç })`;
                
                // æ»šåŠ¨åˆ°è¡¨æ ¼ä¸­çš„å¯¹åº”è¡Œ
                scrollToTableRow(highlightedStock);
            }
            
            // æ›´æ–°è¡¨æ ¼å’Œå›¾è¡¨é«˜äº®
            updateTable();
            updateChart();
        }

        // æ»šåŠ¨åˆ°è¡¨æ ¼ä¸­çš„æŒ‡å®šè¡Œ
        function scrollToTableRow(stock) {
            const tableBody = document.getElementById('tableBody');
            const rows = tableBody.getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                if (cells.length > 1) {
                    const code = cells[0].textContent;
                    const name = cells[1].textContent;
                    
                    if ((stock.ä»£ç  && code === stock.ä»£ç ) || 
                        (stock.åç§° && name === stock.åç§°)) {
                        // æ»šåŠ¨åˆ°è¯¥è¡Œ
                        rows[i].scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                        break;
                    }
                }
            }
        }

        // å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶
        function processFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('è¯·é€‰æ‹©æ–‡ä»¶');
                return;
            }
            
            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            if (fileExtension === 'csv') {
                // å¤„ç†CSVæ–‡ä»¶
                processCsvFile(file);
            } else if (['xlsx', 'xls'].includes(fileExtension)) {
                // å¤„ç†Excelæ–‡ä»¶
                processExcelFile(file);
            } else {
                alert('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ã€‚è¯·ä¸Šä¼ CSVæˆ–Excelæ–‡ä»¶ã€‚');
            }
        }

        // å¤„ç†CSVæ–‡ä»¶
        function processCsvFile(file) {
            Papa.parse(file, {
                header: true,
                dynamicTyping: true, // è‡ªåŠ¨è½¬æ¢æ•°å­—ç±»å‹
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        // è¿‡æ»¤æ‰ç©ºè¡Œ
                        const filteredData = results.data.filter(row => 
                            Object.keys(row).length > 0 && 
                            Object.values(row).some(val => val !== null && val !== '')
                        );
                        
                        if (filteredData.length > 0) {
                            // æ£€æŸ¥æ•°æ®æ ¼å¼
                            if ('åç§°' in filteredData[0]) {
                                stockData = filteredData;
                                initializeData();
                            } else {
                                alert('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ã€‚è¯·ç¡®ä¿æ–‡ä»¶åŒ…å«å¿…è¦çš„åˆ—ï¼ˆå¦‚åç§°ç­‰ï¼‰ã€‚');
                            }
                        } else {
                            alert('æ–‡ä»¶æ•°æ®ä¸ºç©ºæˆ–æ— æ•ˆã€‚');
                        }
                    } else {
                        alert('æ–‡ä»¶æ•°æ®ä¸ºç©ºã€‚');
                    }
                },
                error: function(error) {
                    console.error('å¤„ç†CSVæ–‡ä»¶æ—¶å‡ºé”™:', error);
                    alert('å¤„ç†CSVæ–‡ä»¶æ—¶å‡ºé”™: ' + error.message);
                }
            });
        }

        // å¤„ç†Excelæ–‡ä»¶
        function processExcelFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // è½¬æ¢ä¸ºJSON
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    // æ£€æŸ¥æ•°æ®æ ¼å¼
                    if (jsonData.length > 0 && 'åç§°' in jsonData[0]) {
                        stockData = jsonData;
                        initializeData();
                    } else {
                        alert('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ã€‚è¯·ç¡®ä¿æ–‡ä»¶åŒ…å«å¿…è¦çš„åˆ—ï¼ˆå¦‚åç§°ç­‰ï¼‰ã€‚');
                    }
                } catch (error) {
                    console.error('å¤„ç†Excelæ–‡ä»¶æ—¶å‡ºé”™:', error);
                    alert('å¤„ç†Excelæ–‡ä»¶æ—¶å‡ºé”™: ' + error.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // æ›´æ–°æ•°æ®è¡¨æ ¼
        function updateTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            stockData.forEach(stock => {
                const row = document.createElement('tr');
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯é«˜äº®çš„è‚¡ç¥¨
                if (highlightedStock && 
                    ((highlightedStock.ä»£ç  && stock.ä»£ç  === highlightedStock.ä»£ç ) || 
                     (highlightedStock.åç§° && stock.åç§° === highlightedStock.åç§°))) {
                    row.classList.add('highlighted-row');
                }
                
                columns.forEach(column => {
                    const cell = document.createElement('td');
                    const value = stock[column];
                    
                    // å¯¹äºæ•°å€¼ï¼Œä¿ç•™ä¸¤ä½å°æ•°
                    if (typeof value === 'number') {
                        cell.textContent = value.toFixed(2);
                    } else {
                        cell.textContent = value || '';
                    }
                    
                    row.appendChild(cell);
                });
                
                tableBody.appendChild(row);
            });
        }

        // è¡¨æ ¼æ’åº
        function sortTable(column) {
            // å¦‚æœå·²ç»æŒ‰è¿™åˆ—æ’åºï¼Œåˆ‡æ¢æ–¹å‘
            if (sortConfig.column === column) {
                sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortConfig.column = column;
                sortConfig.direction = 'asc';
            }
            
            // æ’åºæ•°æ®
            stockData.sort((a, b) => {
                let valueA = a[column];
                let valueB = b[column];
                
                // è½¬æ¢ä¸ºæ•°å­—è¿›è¡Œæ¯”è¾ƒï¼ˆå¦‚æœå¯èƒ½ï¼‰
                if (!isNaN(valueA) && !isNaN(valueB)) {
                    valueA = Number(valueA);
                    valueB = Number(valueB);
                } else {
                    // ç¡®ä¿æ˜¯å­—ç¬¦ä¸²æ¯”è¾ƒ
                    valueA = String(valueA || '');
                    valueB = String(valueB || '');
                }
                
                // æ¯”è¾ƒ
                if (valueA < valueB) {
                    return sortConfig.direction === 'asc' ? -1 : 1;
                }
                if (valueA > valueB) {
                    return sortConfig.direction === 'asc' ? 1 : -1;
                }
                return 0;
            });
            
            // æ›´æ–°è¡¨æ ¼å’Œå›¾è¡¨
            initializeTable();
            updateChart();
        }

        // æ›´æ–°å›¾è¡¨
        function updateChart() {
            const xAxis = document.getElementById('xAxis').value;
            const yAxis = document.getElementById('yAxis').value;
            const bubbleSize = document.getElementById('bubbleSize').value;
            const showLabels = document.getElementById('showLabels').checked;
            
            // è®¡ç®—æ°”æ³¡å¤§å°çš„å½’ä¸€åŒ–å› å­
            const bubbleValues = stockData.map(stock => Math.abs(stock[bubbleSize] || 0));
            const maxBubbleValue = Math.max(...bubbleValues) || 1;
            
            // è·å–ç”»å¸ƒä¸Šä¸‹æ–‡
            const ctx = document.getElementById('stockChart').getContext('2d');
            
            // å¦‚æœå·²æœ‰å›¾è¡¨ï¼Œå…ˆé”€æ¯
            if (myChart) {
                myChart.destroy();
            }
            
            // å‡†å¤‡æ•°æ®ç‚¹å’Œé¢œè‰²
            const dataPoints = [];
            const backgroundColors = [];
            const borderColors = [];
            const borderWidths = [];
            
            stockData.forEach(stock => {
                // è®¡ç®—æ°”æ³¡å¤§å° (å½’ä¸€åŒ–ä¸º5-30èŒƒå›´)
                let size = Math.abs(stock[bubbleSize] || 0) / maxBubbleValue * 25 + 5;
                
                // æ°”æ³¡å¤§å°çš„æœ€å°å€¼é™åˆ¶
                if (isNaN(size) || size < 5) size = 5;
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯é«˜äº®çš„è‚¡ç¥¨
                const isHighlighted = highlightedStock && 
                    ((highlightedStock.ä»£ç  && stock.ä»£ç  === highlightedStock.ä»£ç ) || 
                     (highlightedStock.åç§° && stock.åç§° === highlightedStock.åç§°));
                
                dataPoints.push({
                    x: parseFloat((stock[xAxis] || 0).toString()),
                    y: parseFloat((stock[yAxis] || 0).toString()),
                    r: isHighlighted ? size * 1.3 : size,
                    stock: stock,
                    highlighted: isHighlighted
                });
                
                // è®¾ç½®é¢œè‰²ï¼šé«˜äº®ä¸ºçº¢è‰²ï¼Œå…¶ä»–ä¸ºæ¸å˜è‰²
                const h = (dataPoints.length * 137.5) % 360;
                backgroundColors.push(isHighlighted ? 'rgba(255, 0, 0, 0.7)' : `hsla(${h}, 70%, 60%, 0.7)`);
                borderColors.push(isHighlighted ? 'rgba(255, 0, 0, 1)' : 'rgba(255, 255, 255, 0.7)');
                borderWidths.push(isHighlighted ? 2 : 1);
            });
            
            // åˆ›å»ºæ–°å›¾è¡¨
            myChart = new Chart(ctx, {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'è‚¡ç¥¨æ•°æ®',
                        data: dataPoints,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: borderWidths
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: xAxis
                            },
                            grid: {
                                display: true
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: yAxis
                            },
                            grid: {
                                display: true
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const stock = context.raw.stock;
                                    return [
                                        `åç§°: ${stock.åç§° || ''}`,
                                        `ä»£ç : ${stock.ä»£ç  || ''}`,
                                        `${xAxis}: ${typeof stock[xAxis] === 'number' ? stock[xAxis].toFixed(2) : (stock[xAxis] || 0)}`,
                                        `${yAxis}: ${typeof stock[yAxis] === 'number' ? stock[yAxis].toFixed(2) : (stock[yAxis] || 0)}`,
                                        `${bubbleSize}: ${typeof stock[bubbleSize] === 'number' ? stock[bubbleSize].toFixed(2) : (stock[bubbleSize] || 0)}`
                                    ];
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: `çŸ¥è¡ŒAI ä¸‰ç»´æ¯”ä»·ç³»ç»Ÿ (æ°”æ³¡å¤§å°è¡¨ç¤º${bubbleSize})`,
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            display: false
                        }
                    },
                    animation: {
                        duration: 500
                    }
                },
                plugins: [{
                    id: 'stockLabels',
                    afterDatasetDraw: function(chart) {
                        const ctx = chart.ctx;
                        chart.data.datasets.forEach((dataset, i) => {
                            const meta = chart.getDatasetMeta(i);
                            meta.data.forEach((element, index) => {
                                const data = dataPoints[index];
                                const stock = data.stock;
                                const position = element.getCenterPoint();
                                
                                // æ ¹æ®æ˜¯å¦é«˜äº®æˆ–æ˜¯å¦æ˜¾ç¤ºæ‰€æœ‰æ ‡ç­¾å†³å®šæ˜¯å¦æ˜¾ç¤ºæ ‡ç­¾
                                if (showLabels || data.highlighted) {
                                    // è®¾ç½®æ–‡æœ¬æ ·å¼
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'bottom';
                                    
                                    // é«˜äº®æ ‡ç­¾ä½¿ç”¨æ›´å¤§æ›´ç²—çš„å­—ä½“
                                    if (data.highlighted) {
                                        ctx.font = 'bold 14px Arial';
                                        ctx.fillStyle = '#ff0000';
                                    } else {
                                        ctx.font = '12px Arial';
                                        ctx.fillStyle = '#333';
                                    }
                                    
                                    // ç»˜åˆ¶è‚¡ç¥¨åç§°
                                    ctx.fillText(stock.åç§° || '', position.x, position.y - (data.r + 2));
                                    
                                    // å¦‚æœæ˜¯é«˜äº®çš„ï¼Œæ·»åŠ ä¸€ä¸ªåœ†åœˆ
                                    if (data.highlighted) {
                                        ctx.beginPath();
                                        ctx.arc(position.x, position.y, data.r + 5, 0, Math.PI * 2);
                                        ctx.strokeStyle = 'red';
                                        ctx.lineWidth = 2;
                                        ctx.stroke();
                                    }
                                }
                            });
                        });
                    }
                }]
            });
        }

        // å¯¹å­—ç¬¦ä¸²ç™¾åˆ†æ¯”è½¬æ¢ä¸ºæ•°å­—çš„è¾…åŠ©å‡½æ•°
        function parsePercentage(value) {
            if (typeof value === 'string' && value.endsWith('%')) {
                return parseFloat(value) / 100;
            }
            return parseFloat(value);
        }
    </script>
</body>
</html>